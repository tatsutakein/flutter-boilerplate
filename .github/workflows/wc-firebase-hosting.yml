name: "Deploy to Firebase Hosting"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      gh-app-id:
        required: true
        type: string
      channel-id:
        required: false
        type: string
      project-id:
        required: true
        type: string
    secrets:
      gh-app-private-key:
        required: true
      firebase-service-account:
        required: true

jobs:
  build-and-deploy:
    environment: '${{ inputs.environment }}'
    runs-on: ubuntu-22.04
    steps:
      # https://github.com/marketplace/actions/checkout
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      # https://github.com/marketplace/actions/mise-action
      - name: mise action
        uses: jdx/mise-action@3e282fcd55c8de21f232397e9fb876cd33e612f1 # v2.0.3

      # https://github.com/marketplace/actions/melos-action
      - name: Melos action
        uses: bluefireteam/melos-action@63916098bc0ef1e403907e419b61b284108d755e # v3

      # https://github.com/marketplace/actions/create-github-app-token
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@7bfa3a4717ef143a604ee0a99d859b8886a96d00 # v1.9.3
        id: app-token
        with:
          app-id: ${{ inputs.gh-app-id }}
          private-key: ${{ secrets.gh-app-private-key }}

      # https://github.com/marketplace/actions/deploy-to-firebase-hosting
      - uses: FirebaseExtended/action-hosting-deploy@120e124148ab7016bec2374e5050f15051255ba2 # v0.7.1
        with:
          repoToken: '${{ steps.app-token.outputs.token }}'
          firebaseServiceAccount: '${{ secrets.firebase-service-account }}'
          channelId: '${{ inputs.channel-id }}'
          projectId: '${{ inputs.project-id }}'
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks